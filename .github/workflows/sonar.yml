name: SonarCloud Scan
on:
  push:
    branches:
      - main
  pull_request:
    types: [opened, synchronize, reopened]

env:
  CARGO_TERM_COLOR: always

jobs:
  sonarcloud:
    name: SonarCloud
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0  # Full history for accurate blame information

      # ========================================================================
      # Rust Setup and Coverage
      # ========================================================================
      - name: Install Rust toolchain
        run: |
          rustup toolchain install stable --profile minimal
          rustup component add llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@0bc4cd8a3e21db4cb9519857377b0c8c5e150de5 # v2.67.2
        with:
          tool: cargo-llvm-cov

      - name: Generate Rust coverage
        run: |
          # Run Rust tests with coverage in LCOV format
          cargo llvm-cov --all-features --workspace --lcov --output-path lcov.info
          
          # Show coverage summary
          echo "=== Rust Coverage Summary ==="
          cargo llvm-cov report --summary-only || true

      # ========================================================================
      # Python Setup and Coverage
      # ========================================================================
      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: '3.10'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          pip install -e .

      - name: Generate Python coverage
        run: |
          # Run Python tests with coverage in Cobertura XML format
          pytest tests/python/ \
            --cov=edgefirst \
            --cov-report=xml:coverage.xml \
            --cov-report=term \
            -v || true
          
          # Show coverage file exists
          if [ -f coverage.xml ]; then
            echo "=== Python coverage.xml generated ==="
            head -20 coverage.xml
          else
            echo "Warning: No Python tests found or coverage.xml not generated"
            # Create empty coverage file to avoid SonarCloud warning
            echo '<?xml version="1.0" ?><coverage version="1.0"></coverage>' > coverage.xml
          fi

      # ========================================================================
      # SonarCloud Analysis
      # ========================================================================
      - name: Verify coverage files
        run: |
          echo "=== Coverage Files ==="
          ls -la *.info *.xml 2>/dev/null || echo "No coverage files found"
          echo ""
          echo "=== LCOV Summary ==="
          if [ -f lcov.info ]; then
            head -50 lcov.info
            echo "..."
            wc -l lcov.info
          fi

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602 # v6.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
