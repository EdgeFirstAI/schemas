name: Test

on:
  push:
    branches:
      - '**'
  pull_request:
    types: [opened, synchronize, reopened]

env:
  CARGO_TERM_COLOR: always

jobs:
  # ============================================================================
  # Version Sync Check (fast, runs first)
  # ============================================================================
  version-check:
    name: Version Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Check version synchronization
        run: bash .github/scripts/check_version_sync.sh

  # ============================================================================
  # Rust Format Check (fast, runs in parallel)
  # ============================================================================
  format:
    name: Format
    runs-on: ubuntu-latest
    env:
      RUSTV: nightly-2024-04-09
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install Rust
        run: |
          rustup toolchain install $RUSTV
          rustup component add --toolchain $RUSTV rustfmt

      - name: Check formatting
        run: cargo +$RUSTV fmt -- --check

  # ============================================================================
  # Rust Tests with Coverage
  # ============================================================================
  rust-test:
    name: Rust Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0  # Full history for SonarCloud blame

      - name: Install Rust toolchain
        run: |
          rustup toolchain install stable --profile minimal
          rustup component add llvm-tools-preview clippy

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@0bc4cd8a3e21db4cb9519857377b0c8c5e150de5 # v2.67.2
        with:
          tool: cargo-llvm-cov

      - name: Run Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests with coverage
        run: |
          cargo llvm-cov test --all-features --workspace \
            --lcov --output-path lcov.info

      - name: Generate coverage summary
        id: coverage
        run: |
          TOTAL_LINES=$(grep -E "^LF:" lcov.info 2>/dev/null | cut -d: -f2 | paste -sd+ | bc 2>/dev/null || echo "0")
          COVERED_LINES=$(grep -E "^LH:" lcov.info 2>/dev/null | cut -d: -f2 | paste -sd+ | bc 2>/dev/null || echo "0")
          if [ -z "$TOTAL_LINES" ]; then TOTAL_LINES=0; fi
          if [ -z "$COVERED_LINES" ]; then COVERED_LINES=0; fi
          if [ "$TOTAL_LINES" -gt 0 ]; then
            COVERAGE=$(echo "scale=2; $COVERED_LINES * 100 / $TOTAL_LINES" | bc)
          else
            COVERAGE="0"
          fi
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Rust coverage: $COVERAGE% ($COVERED_LINES/$TOTAL_LINES lines)"

      - name: Upload Rust coverage artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: rust-coverage
          path: lcov.info
          retention-days: 7

  # ============================================================================
  # C API Tests (with Rust FFI coverage via instrumented library)
  # ============================================================================
  # C tests call into libedgefirst_schemas.so which is built with LLVM coverage
  # instrumentation. When C code calls Rust FFI functions, profraw files are
  # generated capturing FFI code paths that Rust unit tests don't exercise.
  c-test:
    name: C API Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install Rust toolchain
        run: |
          rustup toolchain install stable --profile minimal
          rustup component add llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@0bc4cd8a3e21db4cb9519857377b0c8c5e150de5 # v2.67.2
        with:
          tool: cargo-llvm-cov

      - name: Install Criterion test framework
        run: |
          sudo apt-get update
          sudo apt-get install -y libcriterion-dev

      - name: Build instrumented library and run C tests
        run: |
          # Set up LLVM coverage environment
          # This exports RUSTFLAGS for instrumentation and LLVM_PROFILE_FILE for profraw output
          source <(cargo llvm-cov show-env --export-prefix)
          
          # Build the Rust library with coverage instrumentation
          # The library will be in target/release/libedgefirst_schemas.so
          cargo build --release
          
          # Build and run C tests against the instrumented library
          # When C code calls Rust FFI functions, profraw files are generated
          export LD_LIBRARY_PATH=$PWD/target/release:$LD_LIBRARY_PATH
          make test-c-xml
          
          # Generate LCOV coverage report from the profraw files
          # This captures all FFI code paths exercised by C tests
          cargo llvm-cov report --lcov --output-path c-api-lcov.info
          
          echo "=== C API Coverage Summary ==="
          if [ -f c-api-lcov.info ]; then
            LINES=$(grep -c "^SF:" c-api-lcov.info || echo "0")
            echo "Source files with coverage data: $LINES"
          else
            echo "WARNING: No coverage data generated"
          fi

      - name: Upload C API coverage artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: c-api-coverage
          path: c-api-lcov.info
          retention-days: 7
        if: always()

      - name: Test Summary
        uses: EnricoMi/publish-unit-test-result-action@27d65e188ec43221b20d26de30f4892fad91df2f # v2.22.0
        with:
          files: "build/test-results/*.xml"
          check_name: "C API Test Results"
          comment_mode: "off"
        if: always()

  # ============================================================================
  # Python Tests with Coverage
  # ============================================================================
  python-test:
    name: Python Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov
          pip install -e .

      - name: Run tests with coverage
        run: |
          # Run Python tests if they exist
          if [ -d "tests/python" ] && [ -n "$(find tests/python -name 'test_*.py' 2>/dev/null)" ]; then
            pytest tests/python/ \
              --cov=edgefirst \
              --cov-report=xml:coverage.xml \
              --cov-report=term \
              -v
          else
            echo "No Python tests found, generating empty coverage"
            # Generate minimal coverage by importing the package
            python -c "import edgefirst.schemas"
            # Create a minimal coverage file
            pip install coverage
            coverage run --source=edgefirst -m pytest --collect-only 2>/dev/null || true
            coverage xml -o coverage.xml || echo '<?xml version="1.0"?><coverage version="1.0"></coverage>' > coverage.xml
          fi

      - name: Upload Python coverage artifact
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: python-coverage
          path: coverage.xml
          retention-days: 7

  # ============================================================================
  # SonarCloud Analysis (runs after all tests complete)
  # ============================================================================
  sonarcloud:
    name: SonarCloud
    runs-on: ubuntu-latest
    needs: [rust-test, c-test, python-test]
    # Only run on main repo (not forks) due to secrets
    if: github.event.pull_request.head.repo.full_name == github.repository || github.event_name == 'push'
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0  # Full history for accurate blame

      - name: Download Rust coverage
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: rust-coverage
          path: .

      - name: Download C API coverage
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: c-api-coverage
          path: .
        continue-on-error: true  # C API coverage is optional (may fail if no FFI paths exercised)

      - name: Download Python coverage
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: python-coverage
          path: .

      - name: Merge Rust coverage reports
        run: |
          # Merge Rust unit test coverage and C API FFI coverage
          if [ -f c-api-lcov.info ]; then
            echo "Merging Rust unit test and C API FFI coverage..."
            cat lcov.info c-api-lcov.info > merged-rust-lcov.info
            mv merged-rust-lcov.info lcov.info
          else
            echo "No C API coverage to merge (c-api-lcov.info not found)"
          fi

      - name: Verify coverage files
        run: |
          echo "=== Coverage Files ==="
          ls -la lcov.info coverage.xml c-api-lcov.info 2>/dev/null || echo "Some coverage files missing"
          echo ""
          if [ -f lcov.info ]; then
            echo "=== Rust LCOV Summary ==="
            RUST_FILES=$(grep -c "^SF:" lcov.info || echo "0")
            echo "Source files with coverage: $RUST_FILES"
            echo ""
            echo "=== First 30 lines ==="
            head -30 lcov.info
          fi
          if [ -f coverage.xml ]; then
            echo ""
            echo "=== Python Coverage XML ==="
            head -20 coverage.xml
          fi

      - name: SonarCloud Scan
        uses: SonarSource/sonarqube-scan-action@fd88b7d7ccbaefd23d8f36f73b59db7a3d246602 # v6.0.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
