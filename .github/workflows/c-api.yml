name: C API Tests

on:
  push:
    branches:
      - '**'
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  # ==========================================================================
  # C API Tests
  # ==========================================================================
  c-tests:
    name: C API Tests
    runs-on: ubuntu-22.04
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install Rust toolchain
        run: |
          rustup toolchain install stable --profile minimal
          rustup component add llvm-tools-preview

      - name: Install cargo-llvm-cov
        uses: taiki-e/install-action@0bc4cd8a3e21db4cb9519857377b0c8c5e150de5 # v2.67.2
        with:
          tool: cargo-llvm-cov

      - name: Install Criterion test framework
        run: |
          sudo apt-get update
          sudo apt-get install -y libcriterion-dev

      - name: Build coverage-instrumented library
        run: |
          # Set up coverage environment
          eval "$(cargo llvm-cov show-env --export-prefix)"
          # Build release library with coverage instrumentation
          cargo build --release

      - name: Build and run C tests
        run: |
          # Export library path for runtime linking
          export LD_LIBRARY_PATH=$PWD/target/release:$LD_LIBRARY_PATH
          # Build and run C tests with XML output for reporting
          make test-c-xml

      - name: Test Summary
        uses: EnricoMi/publish-unit-test-result-action@27d65e188ec43221b20d26de30f4892fad91df2f # v2.22.0
        with:
          files: "build/test-results/*.xml"
          check_name: "C API Test Results"
          comment_mode: "off"
        if: always()
